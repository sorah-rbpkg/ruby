Addresses CVE-2024-27282

From 989a2355808a63fc45367785c82ffd46d18c900a Mon Sep 17 00:00:00 2001
From: Hiroshi SHIBATA <hsbt@ruby-lang.org>
Date: Fri, 12 Apr 2024 15:01:47 +1000
Subject: [PATCH] Fix Use-After-Free issue for Regexp

Co-authored-by: Isaac Peka <7493006+isaac-peka@users.noreply.github.com>
---
 regexec.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

From 33e5b47c16f1fd3382186e6ffe73cfc6e00946f7 Mon Sep 17 00:00:00 2001
From: Isaac Peka <7493006+isaac-peka@users.noreply.github.com>
Date: Thu, 24 Aug 2023 12:14:33 +0100
Subject: [PATCH] Fix handling of reg->dmin in Regex matching

---
 regexec.c | 10 ++++++++++
 1 file changed, 10 insertions(+)


--- ruby3.1-3.1.2.orig/regexec.c
+++ ruby3.1-3.1.2/regexec.c
@@ -2528,8 +2528,8 @@ match_at(regex_t* reg, const UChar* str,
     CASE(OP_MEMORY_END_PUSH_REC)  MOP_IN(OP_MEMORY_END_PUSH_REC);
       GET_MEMNUM_INC(mem, p);
       STACK_GET_MEM_START(mem, stkp); /* should be before push mem-end. */
-      STACK_PUSH_MEM_END(mem, s);
       mem_start_stk[mem] = GET_STACK_INDEX(stkp);
+      STACK_PUSH_MEM_END(mem, s);
       MOP_OUT;
       JUMP;
 
@@ -3902,12 +3902,17 @@ forward_search_range(regex_t* reg, const
 		     UChar* range, UChar** low, UChar** high, UChar** low_prev)
 {
   UChar *p, *pprev = (UChar* )NULL;
+  size_t input_len = end - str;
 
 #ifdef ONIG_DEBUG_SEARCH
   fprintf(stderr, "forward_search_range: str: %"PRIuPTR" (%p), end: %"PRIuPTR" (%p), s: %"PRIuPTR" (%p), range: %"PRIuPTR" (%p)\n",
 	  (uintptr_t )str, str, (uintptr_t )end, end, (uintptr_t )s, s, (uintptr_t )range, range);
 #endif
 
+  if (reg->dmin > input_len) {
+    return 0;
+  }
+
   p = s;
   if (reg->dmin > 0) {
     if (ONIGENC_IS_SINGLEBYTE(reg->enc)) {
@@ -4044,6 +4049,11 @@ backward_search_range(regex_t* reg, cons
 		      UChar** low, UChar** high)
 {
   UChar *p;
+  size_t input_len = end - str;
+
+  if (reg->dmin > input_len) {
+    return 0;
+  }
 
   range += reg->dmin;
   p = s;
