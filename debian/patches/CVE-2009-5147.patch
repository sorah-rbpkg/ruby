Description: CVE-2009-5147: DL::dlopen could open a library with tainted library name
Origin: upstream, https://github.com/ruby/ruby/commit/4600cf725a86ce31266153647ae5aa1197b1215b
Debian-Bug: https://bugs.debian.org/796344
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
Reviewed-by: Petter Reinholdtsen <pere@hungry.com>

Index: ruby2.1-2.1.5/ext/dl/handle.c
===================================================================
--- ruby2.1-2.1.5.orig/ext/dl/handle.c	2016-06-07 07:02:28.284056469 +0200
+++ ruby2.1-2.1.5/ext/dl/handle.c	2016-06-07 07:02:28.284056469 +0200
@@ -5,6 +5,8 @@
 #include <ruby.h>
 #include "dl.h"
 
+#define SafeStringValuePtr(v) (rb_string_value(&v), rb_check_safe_obj(v), RSTRING_PTR(v))
+
 VALUE rb_cDLHandle;
 
 #ifdef _WIN32
@@ -132,11 +134,11 @@
 	cflag = RTLD_LAZY | RTLD_GLOBAL;
 	break;
       case 1:
-	clib = NIL_P(lib) ? NULL : StringValuePtr(lib);
+	clib = NIL_P(lib) ? NULL : SafeStringValuePtr(lib);
 	cflag = RTLD_LAZY | RTLD_GLOBAL;
 	break;
       case 2:
-	clib = NIL_P(lib) ? NULL : StringValuePtr(lib);
+	clib = NIL_P(lib) ? NULL : SafeStringValuePtr(lib);
 	cflag = NUM2INT(flag);
 	break;
       default:
