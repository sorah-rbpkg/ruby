From: Sorah Fukumori <her@sorah.jp>
Date: Sun, 5 Feb 2023 06:25:03 +0900
Subject: extract-gems-sequential: Keep using RUNRUBY

1. sorah-rbpkg's modified rubyN.M-gems requires to kick
   extract-gems and our build environment has no BASERUBY.

   Partially reverts https://github.com/ruby/ruby/pull/6203

2. For the same reason, partially reverting
   https://github.com/ruby/ruby/pull/7347
   to avoid calling git for extracting gems.
---
 common.mk | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/common.mk b/common.mk
index 08fee91..b829a63 100644
--- a/common.mk
+++ b/common.mk
@@ -1504,7 +1504,7 @@ update-gems$(sequential): PHONY
 
 extract-gems$(sequential): PHONY
 	$(ECHO) Extracting bundled gem files...
-	$(Q) $(BASERUBY) -C "$(srcdir)" \
+	$(Q) $(RUNRUBY) -C "$(srcdir)" \
 	    -Itool/lib -rfileutils -rbundled_gem $(split_option) -answ \
 	    -e 'BEGIN {d = ".bundle/gems"}' \
 	    -e 'gem, ver, _, rev = *$$F' \
@@ -1518,7 +1518,17 @@ extract-gems$(sequential): PHONY
 	    -e 'end' \
 	    gems/bundled_gems
 
-extract-gems$(sequential): $(HAVE_GIT:yes=clone-bundled-gems-src)
+clone-bundled-gems-src: PHONY
+	$(Q) $(BASERUBY) -C "$(srcdir)" \
+	    -Itool/lib -rbundled_gem -answ \
+	    -e 'BEGIN {git = $$git}' \
+	    -e 'gem, _, repo, rev = *$$F' \
+	    -e 'next if !rev or /^#/=~gem' \
+	    -e 'gemdir = "gems/src/#{gem}"' \
+	    -e 'BundledGem.checkout(gemdir, repo, rev, git: git)' \
+	    -e 'BundledGem.dummy_gemspec("#{gemdir}/#{gem}.gemspec")' \
+	    -- -git="$(GIT)" \
+	    gems/bundled_gems
 
 flush-gems: outdate-bundled-gems
 outdate-bundled-gems: PHONY
