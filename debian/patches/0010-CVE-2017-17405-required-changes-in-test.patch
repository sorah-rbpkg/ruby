From: usa <usa@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Thu, 14 Dec 2017 14:55:42 +0000
Subject: CVE-2017-17405-required-changes-in-test

* test/net/ftp/test_ftp.rb (process_port_or_eprt): merge a part of
  r56973 to pass the test introduced at previous commit.

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_3@61251 b2dd03c8-39d4-4d8f-98ff-823fe69b080e

Origin: upstream, https://github.com/ruby/ruby/commit/3ec034c597e6d40543bb844dc8f96645bef4bed2
Reviewed-by: Santiago R.R <santiagorr@riseup.net>
Signed-off-by: Santiago R.R <santiagorr@riseup.net>
---
 test/net/ftp/test_ftp.rb | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/test/net/ftp/test_ftp.rb b/test/net/ftp/test_ftp.rb
index fa64d77..1b09c43 100644
--- a/test/net/ftp/test_ftp.rb
+++ b/test/net/ftp/test_ftp.rb
@@ -1651,4 +1651,22 @@ EOF
       end
     end
   end
+
+  def process_port_or_eprt(sock, line)
+    case line
+    when /\APORT (.*)/
+      port_args = $1.split(/,/)
+      host = port_args[0, 4].join(".")
+      port = port_args[4, 2].map(&:to_i).inject {|x, y| (x << 8) + y}
+      sock.print("200 PORT command successful.\r\n")
+      return host, port
+    when /\AEPRT \|2\|(.*?)\|(.*?)\|/
+      host = $1
+      port = $2.to_i
+      sock.print("200 EPRT command successful.\r\n")
+      return host, port
+    else
+      flunk "PORT or EPRT expected"
+    end
+  end
 end
