From: Watson <watson1978@gmail.com>
Date: Tue, 16 Jul 2024 10:48:53 +0900
Subject: CVE-2024-39908 [PATCH] Fix performance issue caused by using
 repeated `>` characters  inside `<?xml` (#170)

A `<` is treated as a string delimiter.
In certain cases, if `<` is used in succession, read and match are
repeated, which slows down the process. Therefore, the following is used
to read ahead to a specific part of the string in advance.

Origin: https://github.com/ruby/rexml/commit/b8a5f4cd5c8fe29c65d7a00e67170223d9d2b50e
Bug: https://www.ruby-lang.org/en/news/2024/07/16/dos-rexml-cve-2024-39908/
Bug-github: https://github.com/advisories/GHSA-4xqq-m2hx-25v8
---
 lib/rexml/parsers/baseparser.rb | 3 ++-
 lib/rexml/source.rb             | 6 +++---
 2 files changed, 5 insertions(+), 4 deletions(-)

Index: ruby/lib/rexml/parsers/baseparser.rb
===================================================================
--- ruby.orig/lib/rexml/parsers/baseparser.rb
+++ ruby/lib/rexml/parsers/baseparser.rb
@@ -125,6 +125,7 @@ module REXML
 
       module Private
         INSTRUCTION_END = /#{NAME}(\s+.*?)?\?>/um
+        INSTRUCTION_TERM = "?>"
         TAG_PATTERN = /((?>#{QNAME_STR}))\s*/um
         CLOSE_PATTERN = /(#{QNAME_STR})\s*>/um
         ATTLISTDECL_END = /\s+#{NAME}(?:#{ATTDEF})*\s*>/um
@@ -641,7 +642,7 @@ module REXML
       end
 
       def process_instruction(start_position)
-        match_data = @source.match(INSTRUCTION_END, true)
+        match_data = @source.match(Private::INSTRUCTION_END, true, term: Private::INSTRUCTION_TERM)
         unless match_data
           message = "Invalid processing instruction node"
           @source.position = start_position
Index: ruby/lib/rexml/source.rb
===================================================================
--- ruby.orig/lib/rexml/source.rb
+++ ruby/lib/rexml/source.rb
@@ -72,7 +72,7 @@ module REXML
       @scanner.scan_until(Regexp.union(term)) or @scanner.rest
     end
 
-    def match(pattern, cons=false)
+    def match(pattern, cons=false, term: nil)
       if cons
         @scanner.scan(pattern).nil? ? nil : @scanner
       else
@@ -184,7 +184,7 @@ module REXML
       end
     end
 
-    def match( pattern, cons=false )
+    def match( pattern, cons=false, term: nil)
       read if @scanner.eos? && @source
       while true
         if cons
@@ -195,7 +195,7 @@ module REXML
         break if md
         return nil if pattern.is_a?(String) && pattern.bytesize <= @scanner.rest_size
         return nil if @source.nil?
-        return nil unless read
+        return nil unless read(term)
       end
 
       md.nil? ? nil : @scanner
Index: ruby/test/rexml/parse/test_notation_declaration.rb
===================================================================
--- ruby.orig/test/rexml/parse/test_notation_declaration.rb
+++ ruby/test/rexml/parse/test_notation_declaration.rb
@@ -35,7 +35,7 @@ Malformed notation declaration: name is
 Line: 5
 Position: 72
 Last 80 unconsumed characters:
- <!NOTATION>  ]> <r/> 
+<!NOTATION>  ]> <r/> 
         DETAIL
       end
 
