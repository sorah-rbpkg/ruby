From: Watson <watson1978@gmail.com>
Date: Tue, 16 Jul 2024 10:48:53 +0900
Subject: CVE-2024-39908 [PATCH] Fix performance issue caused by using
 repeated `>` characters  inside `<?xml` (#170)

A `<` is treated as a string delimiter.
In certain cases, if `<` is used in succession, read and match are
repeated, which slows down the process. Therefore, the following is used
to read ahead to a specific part of the string in advance.

Origin: https://github.com/ruby/rexml/commit/b8a5f4cd5c8fe29c65d7a00e67170223d9d2b50e
Bug: https://www.ruby-lang.org/en/news/2024/07/16/dos-rexml-cve-2024-39908/
Bug-github: https://github.com/advisories/GHSA-4xqq-m2hx-25v8
---
 lib/rexml/parsers/baseparser.rb | 3 ++-
 lib/rexml/source.rb             | 6 +++---
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/lib/rexml/parsers/baseparser.rb b/lib/rexml/parsers/baseparser.rb
index 1ca344f..6ba282d 100644
--- a/lib/rexml/parsers/baseparser.rb
+++ b/lib/rexml/parsers/baseparser.rb
@@ -126,6 +126,7 @@ class BaseParser
 
       module Private
         INSTRUCTION_END = /#{NAME}(\s+.*?)?\?>/um
+        INSTRUCTION_TERM = "?>"
         TAG_PATTERN = /((?>#{QNAME_STR}))\s*/um
         CLOSE_PATTERN = /(#{QNAME_STR})\s*>/um
         ATTLISTDECL_END = /\s+#{NAME}(?:#{ATTDEF})*\s*>/um
@@ -642,7 +643,7 @@ def parse_id_invalid_details(accept_external_id:,
       end
 
       def process_instruction(start_position)
-        match_data = @source.match(INSTRUCTION_END, true)
+        match_data = @source.match(Private::INSTRUCTION_END, true, term: Private::INSTRUCTION_TERM)
         unless match_data
           message = "Invalid processing instruction node"
           @source.position = start_position
diff --git a/lib/rexml/source.rb b/lib/rexml/source.rb
index 83d29e9..0f44c1d 100644
--- a/lib/rexml/source.rb
+++ b/lib/rexml/source.rb
@@ -92,7 +92,7 @@ def read_until(term)
       @scanner.scan_until(Regexp.union(term)) or @scanner.rest
     end
 
-    def match(pattern, cons=false)
+    def match(pattern, cons=false, term: nil)
       if cons
         @scanner.scan(pattern).nil? ? nil : @scanner
       else
@@ -204,7 +204,7 @@ def read_until(term)
       end
     end
 
-    def match( pattern, cons=false )
+    def match( pattern, cons=false, term: nil)
       read if @scanner.eos? && @source
       while true
         if cons
@@ -215,7 +215,7 @@ def match( pattern, cons=false )
         break if md
         return nil if pattern.is_a?(String) && pattern.bytesize <= @scanner.rest_size
         return nil if @source.nil?
-        return nil unless read
+        return nil unless read(term)
       end
 
       md.nil? ? nil : @scanner
