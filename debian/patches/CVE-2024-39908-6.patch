From: Watson <watson1978@gmail.com>
Date: Tue, 16 Jul 2024 11:18:11 +0900
Subject: [PATCH] Fix performance issue caused by using repeated `>`
 characters  inside `<!DOCTYPE root [<!-- PAYLOAD -->]>` (#174)

A `<` is treated as a string delimiter.
In certain cases, if `<` is used in succession, read and match are
repeated, which slows down the process. Therefore, the following is used
to read ahead to a specific part of the string in advance.

Origin: https://github.com/ruby/rexml/commit/a79ac8b4b42a9efabe33a0be31bd82d33fd50347
Bug: https://www.ruby-lang.org/en/news/2024/07/16/dos-rexml-cve-2024-39908/
Bug-github: https://github.com/advisories/GHSA-4xqq-m2hx-25v8
---
 lib/rexml/parsers/baseparser.rb              | 2 +-
 test/parse/test_document_type_declaration.rb | 7 +++++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/lib/rexml/parsers/baseparser.rb b/lib/rexml/parsers/baseparser.rb
index fbf5598..d519c33 100644
--- a/lib/rexml/parsers/baseparser.rb
+++ b/lib/rexml/parsers/baseparser.rb
@@ -363,7 +363,7 @@ def pull_event
                 raise REXML::ParseException.new(message, @source)
               end
               return [:notationdecl, name, *id]
-            elsif md = @source.match(/--(.*?)-->/um, true)
+            elsif md = @source.match(/--(.*?)-->/um, true, term: Private::COMMENT_TERM)
               case md[1]
               when /--/, /-\z/
                 raise REXML::ParseException.new("Malformed comment", @source)
diff --git a/test/parse/test_document_type_declaration.rb b/test/parse/test_document_type_declaration.rb
index 2273437..37c8fc9 100644
--- a/test/parse/test_document_type_declaration.rb
+++ b/test/parse/test_document_type_declaration.rb
@@ -16,5 +16,12 @@ def test_gt_linear_performance_malformed_entity
           end
         end
      end
+
+     def test_gt_linear_performance_comment
+        seq = [10000, 50000, 100000, 150000, 200000]
+        assert_linear_performance(seq, rehearsal: 10) do |n|
+          REXML::Document.new('<!DOCTYPE root [<!-- ' + ">" * n + ' -->]>')
+        end
+      end
   end
 end
