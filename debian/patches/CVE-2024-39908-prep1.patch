From: NAITOH Jun <naitoh@gmail.com>
Date: Mon, 4 Mar 2024 05:24:53 +0900
Subject: Remove `Source#string=` method (#117)

We want to just change scan pointer.

https://github.com/ruby/rexml/pull/114#discussion_r1501773803
> I want to just change scan pointer (`StringScanner#pos=`) instead of
changing `@scanner.string`.

Origin: https://github.com/ruby/rexml/commit/d146162e9a61574499d10428bc0065754cd26601

[backport]
- drop test no need to backport
- drop lib/rexml/parsers/baseparser.rb part not present for older version
---
 lib/rexml/parsers/baseparser.rb               | 20 +++++++++++---------
 lib/rexml/source.rb                           |  8 ++++++--
 test/rexml/parse/test_notation_declaration.rb |  2 +-
 3 files changed, 18 insertions(+), 12 deletions(-)

diff --git a/lib/rexml/parsers/baseparser.rb b/lib/rexml/parsers/baseparser.rb
index a6b2497..1ca344f 100644
--- a/lib/rexml/parsers/baseparser.rb
+++ b/lib/rexml/parsers/baseparser.rb
@@ -225,8 +225,9 @@ def pull_event
         #STDERR.puts @source.encoding
         #STDERR.puts "BUFFER = #{@source.buffer.inspect}"
         if @document_status == nil
+          start_position = @source.position
           if @source.match("<?", true)
-            return process_instruction
+            return process_instruction(start_position)
           elsif @source.match("<!", true)
             if @source.match("--", true)
               return [ :comment, @source.match(/(.*?)-->/um, true)[1] ]
@@ -238,7 +239,7 @@ def pull_event
                 else
                   message = "#{base_error_message}: invalid name"
                 end
-                @source.string = "<!DOCTYPE" + @source.buffer
+                @source.position = start_position
                 raise REXML::ParseException.new(message, @source)
               end
               name = parse_name(base_error_message)
@@ -279,6 +280,7 @@ def pull_event
         end
         if @document_status == :in_doctype
           @source.match(/\s*/um, true) # skip spaces
+          start_position = @source.position
           if @source.match("<!", true)
             if @source.match("ELEMENT", true)
               md = @source.match(/(.*?)>/um, true)
@@ -338,7 +340,7 @@ def pull_event
                 else
                   message = "#{base_error_message}: invalid name"
                 end
-                @source.string = " <!NOTATION" + @source.buffer
+                @source.position = start_position
                 raise REXML::ParseException.new(message, @source)
               end
               name = parse_name(base_error_message)
@@ -368,6 +370,7 @@ def pull_event
           @source.match(/\s*/um, true)
         end
         begin
+          start_position = @source.position
           if @source.match("<", true)
             if @source.match("/", true)
               @namespaces_restore_stack.pop
@@ -380,7 +383,7 @@ def pull_event
               if md.nil? or last_tag != md[1]
                 message = "Missing end tag for '#{last_tag}'"
                 message += " (got '#{md[1]}')" if md
-                @source.string = "</" + @source.buffer if md.nil?
+                @source.position = start_position if md.nil?
                 raise REXML::ParseException.new(message, @source)
               end
               return [ :end_element, last_tag ]
@@ -404,12 +407,12 @@ def pull_event
               raise REXML::ParseException.new( "Declarations can only occur "+
                 "in the doctype declaration.", @source)
             elsif @source.match("?", true)
-              return process_instruction
+              return process_instruction(start_position)
             else
               # Get the next tag
               md = @source.match(TAG_PATTERN, true)
               unless md
-                @source.string = "<" + @source.buffer
+                @source.position = start_position
                 raise REXML::ParseException.new("malformed XML: missing tag start", @source)
               end
               tag = md[1]
@@ -638,11 +641,11 @@ def parse_id_invalid_details(accept_external_id:,
         end
       end
 
-      def process_instruction
+      def process_instruction(start_position)
         match_data = @source.match(INSTRUCTION_END, true)
         unless match_data
           message = "Invalid processing instruction node"
-          @source.string = "<?" + @source.buffer
+          @source.position = start_position
           raise REXML::ParseException.new(message, @source)
         end
         if @document_status.nil? and match_data[1] == "xml"
@@ -678,7 +681,6 @@ def parse_attributes(prefixes)
             name = match[1]
             prefix = match[2]
             local_part = match[3]
-
             unless @source.match(/\s*=\s*/um, true)
               message = "Missing attribute equal: <#{name}>"
               raise REXML::ParseException.new(message, @source)
diff --git a/lib/rexml/source.rb b/lib/rexml/source.rb
index 6b19d39..83d29e9 100644
--- a/lib/rexml/source.rb
+++ b/lib/rexml/source.rb
@@ -100,8 +100,12 @@ def match(pattern, cons=false)
       end
     end
 
-    def string=(string)
-      @scanner.string = string
+    def position
+      @scanner.pos
+    end
+
+    def position=(pos)
+      @scanner.pos = pos
     end
 
     # @return true if the Source is exhausted
diff --git a/test/rexml/parse/test_notation_declaration.rb b/test/rexml/parse/test_notation_declaration.rb
index 19a0536..9e81b6a 100644
--- a/test/rexml/parse/test_notation_declaration.rb
+++ b/test/rexml/parse/test_notation_declaration.rb
@@ -35,7 +35,7 @@ def test_no_name
 Line: 5
 Position: 72
 Last 80 unconsumed characters:
- <!NOTATION>  ]> <r/> 
+<!NOTATION>  ]> <r/> 
         DETAIL
       end
 
