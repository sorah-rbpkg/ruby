From: tomoya ishida <tomoyapenguin@gmail.com>
Date: Thu, 1 Aug 2024 09:21:19 +0900
Subject: [PATCH] Fix source.match performance without specifying term string
  (#186)

Performance problem of `source.match(regexp)` was recently fixed by
specifying terminator string. However, I think maintaining appropriate
terminator string for a regexp is hard.
I propose solving this performance issue by increasing bytes to read in
each iteration.

Origin: https://github.com/ruby/rexml/commit/6cac15d45864c8d70904baa5cbfcc97181000960
Bug-github: https://github.com/advisories/GHSA-r55c-59qm-vjw6
Bug: https://www.ruby-lang.org/en/news/2024/08/01/dos-rexml-cve-2024-41123
---
 lib/rexml/parsers/baseparser.rb | 22 +++++++---------------
 lib/rexml/source.rb             | 21 +++++++++++++++++----
 2 files changed, 24 insertions(+), 19 deletions(-)

Index: ruby/lib/rexml/parsers/baseparser.rb
===================================================================
--- ruby.orig/lib/rexml/parsers/baseparser.rb
+++ ruby/lib/rexml/parsers/baseparser.rb
@@ -124,14 +124,6 @@ module REXML
       }
 
       module Private
-        # Terminal requires two or more letters.
-        INSTRUCTION_TERM = "?>"
-        COMMENT_TERM = "-->"
-        CDATA_TERM = "]]>"
-        DOCTYPE_TERM = "]>"
-        # Read to the end of DOCTYPE because there is no proper ENTITY termination
-        ENTITY_TERM = DOCTYPE_TERM
-
         INSTRUCTION_END = /#{NAME}(\s+.*?)?\?>/um
         TAG_PATTERN = /((?>#{QNAME_STR}))\s*/um
         CLOSE_PATTERN = /(#{QNAME_STR})\s*>/um
@@ -237,7 +229,7 @@ module REXML
             return process_instruction(start_position)
           elsif @source.match("<!", true)
             if @source.match("--", true)
-              md = @source.match(/(.*?)-->/um, true, term: Private::COMMENT_TERM)
+              md = @source.match(/(.*?)-->/um, true)
               if md.nil?
                 raise REXML::ParseException.new("Unclosed comment", @source)
               end
@@ -301,7 +293,7 @@ module REXML
               raise REXML::ParseException.new( "Bad ELEMENT declaration!", @source ) if md.nil?
               return [ :elementdecl, "<!ELEMENT" + md[1] ]
             elsif @source.match("ENTITY", true)
-              match_data = @source.match(Private::ENTITYDECL_PATTERN, true, term: Private::ENTITY_TERM)
+              match_data = @source.match(Private::ENTITYDECL_PATTERN, true)
               unless match_data
                 raise REXML::ParseException.new("Malformed entity declaration", @source)
               end
@@ -370,14 +362,14 @@ module REXML
                 raise REXML::ParseException.new(message, @source)
               end
               return [:notationdecl, name, *id]
-            elsif md = @source.match(/--(.*?)-->/um, true, term: Private::COMMENT_TERM)
+            elsif md = @source.match(/--(.*?)-->/um, true)
               case md[1]
               when /--/, /-\z/
                 raise REXML::ParseException.new("Malformed comment", @source)
               end
               return [ :comment, md[1] ] if md
             end
-          elsif match = @source.match(/(%.*?;)\s*/um, true, term: Private::DOCTYPE_TERM)
+          elsif match = @source.match(/(%.*?;)\s*/um, true)
             return [ :externalentity, match[1] ]
           elsif @source.match(/\]\s*>/um, true)
             @document_status = :after_doctype
@@ -410,7 +402,7 @@ module REXML
               #STDERR.puts "SOURCE BUFFER = #{source.buffer}, #{source.buffer.size}"
               raise REXML::ParseException.new("Malformed node", @source) unless md
               if md[0][0] == ?-
-                md = @source.match(/--(.*?)-->/um, true, term: Private::COMMENT_TERM)
+                md = @source.match(/--(.*?)-->/um, true)
 
                 case md[1]
                 when /--/, /-\z/
@@ -419,7 +411,7 @@ module REXML
 
                 return [ :comment, md[1] ] if md
               else
-                md = @source.match(/\[CDATA\[(.*?)\]\]>/um, true, term: Private::CDATA_TERM)
+                md = @source.match(/\[CDATA\[(.*?)\]\]>/um, true)
                 return [ :cdata, md[1] ] if md
               end
               raise REXML::ParseException.new( "Declarations can only occur "+
@@ -660,7 +652,7 @@ module REXML
       end
 
       def process_instruction(start_position)
-        match_data = @source.match(Private::INSTRUCTION_END, true, term: Private::INSTRUCTION_TERM)
+        match_data = @source.match(Private::INSTRUCTION_END, true)
         unless match_data
           message = "Invalid processing instruction node"
           @source.position = start_position
Index: ruby/lib/rexml/source.rb
===================================================================
--- ruby.orig/lib/rexml/source.rb
+++ ruby/lib/rexml/source.rb
@@ -72,7 +72,7 @@ module REXML
       @scanner.scan_until(Regexp.union(term)) or @scanner.rest
     end
 
-    def match(pattern, cons=false, term: nil)
+    def match(pattern, cons=false)
       if cons
         @scanner.scan(pattern).nil? ? nil : @scanner
       else
@@ -159,10 +159,20 @@ module REXML
       end
     end
 
-    def read(term = nil)
+    def read(term = nil, min_bytes = 1)
       term = encode(term) if term
       begin
-        @scanner << readline(term)
+        str = readline(term)
+        @scanner << str
+        read_bytes = str.bytesize
+        begin
+          while read_bytes < min_bytes
+            str = readline(term)
+            @scanner << str
+            read_bytes += str.bytesize
+          end
+        rescue IOError
+        end
         true
       rescue Exception, NameError
         @source = nil
@@ -188,6 +198,8 @@ module REXML
 
     def match( pattern, cons=false, term: nil)
       read if @scanner.eos? && @source
+      # To avoid performance issue, we need to increase bytes to read per scan
+      min_bytes = 1
       while true
         if cons
           md = @scanner.scan(pattern)
@@ -197,7 +209,8 @@ module REXML
         break if md
         return nil if pattern.is_a?(String) && pattern.bytesize <= @scanner.rest_size
         return nil if @source.nil?
-        return nil unless read(term)
+        return nil unless read(nil, min_bytes)
+        min_bytes *= 2
       end
 
       md.nil? ? nil : @scanner
Index: ruby/test/rexml/parse/test_processing_instruction.rb
===================================================================
--- ruby.orig/test/rexml/parse/test_processing_instruction.rb
+++ ruby/test/rexml/parse/test_processing_instruction.rb
@@ -13,11 +13,11 @@ module REXMLTests
           parse("<??>")
         end
         assert_equal(<<-DETAIL.chomp, exception.to_s)
-Invalid processing instruction node
+Malformed XML: Invalid processing instruction node: invalid name
 Line: 1
 Position: 4
 Last 80 unconsumed characters:
-<??>
+?>
         DETAIL
       end
 
