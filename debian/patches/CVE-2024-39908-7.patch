From: Watson <watson1978@gmail.com>
Date: Tue, 16 Jul 2024 11:26:57 +0900
Subject: [PATCH] Fix performance issue caused by using repeated `>`
 characters  inside `<!DOCTYPE name [<!ENTITY>]>` (#175)

A `<` is treated as a string delimiter.
In certain cases, if `<` is used in succession, read and match are
repeated, which slows down the process. Therefore, the following is used
to read ahead to a specific part of the string in advance.

Origin: https://github.com/ruby/rexml/commit/67efb5951ed09dbb575c375b130a1e469f437d1f
Bug: https://www.ruby-lang.org/en/news/2024/07/16/dos-rexml-cve-2024-39908/
Bug-github: https://github.com/advisories/GHSA-4xqq-m2hx-25v8
---
 lib/rexml/parsers/baseparser.rb              | 8 ++++++--
 test/parse/test_document_type_declaration.rb | 7 +++++++
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/lib/rexml/parsers/baseparser.rb b/lib/rexml/parsers/baseparser.rb
index d519c33..45d67f5 100644
--- a/lib/rexml/parsers/baseparser.rb
+++ b/lib/rexml/parsers/baseparser.rb
@@ -125,11 +125,15 @@ module REXML
       }
 
       module Private
-        INSTRUCTION_END = /#{NAME}(\s+.*?)?\?>/um
+        # Terminal requires two or more letters.
         INSTRUCTION_TERM = "?>"
         COMMENT_TERM = "-->"
         CDATA_TERM = "]]>"
         DOCTYPE_TERM = "]>"
+        # Read to the end of DOCTYPE because there is no proper ENTITY termination
+        ENTITY_TERM = DOCTYPE_TERM
+
+        INSTRUCTION_END = /#{NAME}(\s+.*?)?\?>/um
         TAG_PATTERN = /((?>#{QNAME_STR}))\s*/um
         CLOSE_PATTERN = /(#{QNAME_STR})\s*>/um
         ATTLISTDECL_END = /\s+#{NAME}(?:#{ATTDEF})*\s*>/um
@@ -298,7 +302,7 @@ module REXML
               raise REXML::ParseException.new( "Bad ELEMENT declaration!", @source ) if md.nil?
               return [ :elementdecl, "<!ELEMENT" + md[1] ]
             elsif @source.match("ENTITY", true)
-              match = [:entitydecl, *@source.match(ENTITYDECL_PATTERN, true).captures.compact]
+              match = [:entitydecl, *@source.match(Private::ENTITYDECL_PATTERN, true, term: Private::ENTITY_TERM).captures.compact]
               ref = false
               if match[1] == '%'
                 ref = true
diff --git a/test/parse/test_document_type_declaration.rb b/test/parse/test_document_type_declaration.rb
index 37c8fc9..26bfac3 100644
--- a/test/parse/test_document_type_declaration.rb
+++ b/test/parse/test_document_type_declaration.rb
@@ -23,5 +23,12 @@ module REXMLTests
           REXML::Document.new('<!DOCTYPE root [<!-- ' + ">" * n + ' -->]>')
         end
       end
+
+     def test_gt_linear_performance
+      seq = [10000, 50000, 100000, 150000, 200000]
+      assert_linear_performance(seq, rehearsal: 10) do |n|
+        REXML::Document.new('<!DOCTYPE rubynet [<!ENTITY rbconfig.ruby_version "' + '>' * n + '">')
+      end
+    end
   end
 end
