Origin: https://github.com/ruby/ruby/commit/69f9992ed41920389d4185141a14f02f89a4d306
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2024-08-08

From 69f9992ed41920389d4185141a14f02f89a4d306 Mon Sep 17 00:00:00 2001
From: usa <usa@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Tue, 12 Apr 2022 11:49:45 +0000
Subject: Fix dtoa buffer overrun

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_6@67957 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 test/ruby/test_float.rb | 18 ++++++++++++++++++
 util.c                  |  3 ++-
 version.h               |  2 +-
 3 files changed, 21 insertions(+), 2 deletions(-)

Index: ruby/test/ruby/test_float.rb
===================================================================
--- ruby.orig/test/ruby/test_float.rb
+++ ruby/test/ruby/test_float.rb
@@ -161,6 +161,24 @@ class TestFloat < Test::Unit::TestCase
       assert_equal(-31.0*2**-1027, Float("-0x1f"+("0"*268)+".0p-2099"))
       assert_equal(-31.0*2**-1027, Float("-0x1f"+("0"*600)+".0p-3427"))
     end
+
+    x = nil
+    2000.times do
+      x = Float("0x"+"0"*30)
+      break unless x == 0.0
+    end
+    assert_equal(0.0, x, ->{"%a" % x})
+    x = nil
+    2000.times do
+      begin
+        x = Float("0x1."+"0"*270)
+      rescue ArgumentError => e
+        raise unless /"0x1\.0{270}"/ =~ e.message
+      else
+        break
+      end
+    end
+    assert_nil(x, ->{"%a" % x})
   end
 
   def test_divmod
Index: ruby/util.c
===================================================================
--- ruby.orig/util.c
+++ ruby/util.c
@@ -2001,6 +2001,7 @@ break2:
 	    if (!*++s || !(s1 = strchr(hexdigit, *s))) goto ret0;
 	    if (*s == '0') {
 		while (*++s == '0');
+		if (!*s) goto ret;
 		s1 = strchr(hexdigit, *s);
 	    }
 	    if (s1 != NULL) {
@@ -2023,7 +2024,7 @@ break2:
 		for (; *s && (s1 = strchr(hexdigit, *s)); ++s) {
 		    adj += aadj * ((s1 - hexdigit) & 15);
 		    if ((aadj /= 16) == 0.0) {
-			while (strchr(hexdigit, *++s));
+			while (*++s && strchr(hexdigit, *s));
 			break;
 		    }
 		}
