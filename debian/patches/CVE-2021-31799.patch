From 483f303d02e768b69e476e0b9be4ab2f26389522 Mon Sep 17 00:00:00 2001
From: NAKAMURA Usaku <usa@ruby-lang.org>
Date: Mon, 31 May 2021 23:44:23 +0900
Subject: [PATCH] merge revision(s) a7f5d6ab88 c9ab8fe2 [Backport#17877]

	a fix of RDoc for CVE-2021-31799
---
 lib/rdoc/rdoc.rb            |  2 +-
 test/rdoc/test_rdoc_rdoc.rb | 13 +++++++++++++
 version.h                   |  2 +-
 3 files changed, 15 insertions(+), 2 deletions(-)

--- a/lib/rdoc/rdoc.rb
+++ b/lib/rdoc/rdoc.rb
@@ -433,7 +433,7 @@
     files.reject do |file|
       file =~ /\.(?:class|eps|erb|scpt\.txt|ttf|yml)$/i or
         (file =~ /tags$/i and
-         open(file, 'rb') { |io|
+         File.open(file, 'rb') { |io|
            io.read(100) =~ /\A(\f\n[^,]+,\d+$|!_TAG_)/
          })
     end
--- a/test/rdoc/test_rdoc_rdoc.rb
+++ b/test/rdoc/test_rdoc_rdoc.rb
@@ -330,6 +330,19 @@
     end
   end
 
+  def test_remove_unparseable_CVE_2021_31799
+    omit 'for Un*x platforms' if Gem.win_platform?
+    temp_dir do
+      file_list = ['| touch evil.txt && echo tags']
+      file_list.each do |f|
+        FileUtils.touch f
+      end
+
+      assert_equal file_list, @rdoc.remove_unparseable(file_list)
+      assert_equal file_list, Dir.glob('*')
+    end
+  end
+
   def test_setup_output_dir
     Dir.mktmpdir {|d|
       path = File.join d, 'testdir'
