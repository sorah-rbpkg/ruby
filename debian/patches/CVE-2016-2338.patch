Description: CVE-2016-2338
 An exploitable heap overflow vulnerability exists in the
 Psych::Emitter start_document function of Ruby. In Psych::Emitter
 start_document function heap buffer "head" allocation is made based
 on tags array length. Specially constructed object passed as element
 of tags array can increase this array size after mentioned allocation
 and cause heap overflow.
---

Author: Abhijith PA <abhijith@debian.org>
Origin: https://git.ruby-lang.org/ruby.git/commit/?id=cc0313436160b735a3d41361cb5e3eeb10fcbdad
Origin: https://git.ruby-lang.org/ruby.git/commit/?id=db48c307944a9a18877236bdf9e9b778875f38ed
Last-Update: 2024-07-16
Reviewed-by: Sylvain Beucler <beuc@debian.org>

From cc0313436160b735a3d41361cb5e3eeb10fcbdad Mon Sep 17 00:00:00 2001
From: nobu <nobu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Sun, 13 Dec 2015 09:27:52 +0000
Subject: [PATCH] psych_emitter.c: check string

* ext/psych/psych_emitter.c (start_document): ensure string before
  encoding conversion.

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/trunk@53078 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog                  | 5 +++++
 ext/psych/psych_emitter.c  | 6 ++++--
 test/psych/test_emitter.rb | 1 +
 3 files changed, 10 insertions(+), 2 deletions(-)

From db48c307944a9a18877236bdf9e9b778875f38ed Mon Sep 17 00:00:00 2001
From: nobu <nobu@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Sun, 13 Dec 2015 09:28:51 +0000
Subject: [PATCH] psych_emitter.c: check tags range

* ext/psych/psych_emitter.c (start_document): should not exceed
  tags array range.

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/trunk@53079 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog                  |  5 ++++-
 ext/psych/psych_emitter.c  |  6 ++++--
 test/psych/test_emitter.rb | 15 +++++++++++++++
 3 files changed, 23 insertions(+), 3 deletions(-)

Index: ruby/ext/psych/psych_emitter.c
===================================================================
--- ruby.orig/ext/psych/psych_emitter.c
+++ ruby/ext/psych/psych_emitter.c
@@ -139,16 +139,18 @@ static VALUE start_document(VALUE self,
 
     if(RTEST(tags)) {
 	int i = 0;
+        long len;
 #ifdef HAVE_RUBY_ENCODING_H
 	rb_encoding * encoding = rb_utf8_encoding();
 #endif
 
 	Check_Type(tags, T_ARRAY);
 
-	head  = xcalloc((size_t)RARRAY_LEN(tags), sizeof(yaml_tag_directive_t));
+	len = RARRAY_LEN(tags);
+	head  = xcalloc((size_t)len, sizeof(yaml_tag_directive_t));
 	tail  = head;
 
-	for(i = 0; i < RARRAY_LEN(tags); i++) {
+	for(i = 0; i < len && i < RARRAY_LEN(tags); i++) {
 	    VALUE tuple = RARRAY_PTR(tags)[i];
 	    VALUE name;
 	    VALUE value;
@@ -161,13 +163,15 @@ static VALUE start_document(VALUE self,
 	    }
 	    name  = RARRAY_PTR(tuple)[0];
 	    value = RARRAY_PTR(tuple)[1];
+	    StringValue(name);
+	    StringValue(value);
 #ifdef HAVE_RUBY_ENCODING_H
 	    name = rb_str_export_to_enc(name, encoding);
 	    value = rb_str_export_to_enc(value, encoding);
 #endif
 
-	    tail->handle = (yaml_char_t *)StringValuePtr(name);
-	    tail->prefix = (yaml_char_t *)StringValuePtr(value);
+	    tail->handle = (yaml_char_t *)RSTRING_PTR(name);
+	    tail->prefix = (yaml_char_t *)RSTRING_PTR(value);
 
 	    tail++;
 	}
Index: ruby/test/psych/test_emitter.rb
===================================================================
--- ruby.orig/test/psych/test_emitter.rb
+++ ruby/test/psych/test_emitter.rb
@@ -90,5 +90,20 @@ module Psych
         @emitter.start_sequence(nil, nil, true, :foo)
       end
     end
+
+    def test_resizing_tags
+      tags = []
+      version = [1,1]
+      obj = Object.new
+      obj.instance_variable_set(:@tags, tags)
+      def obj.to_str
+        (1..10).map{|x| @tags.push(["AAAA","BBBB"])}
+        return "x"
+      end
+
+      tags.push([obj, "tag:TALOS"])
+      @emitter.start_document(version, tags, 0)
+      assert(true)
+    end
   end
 end
